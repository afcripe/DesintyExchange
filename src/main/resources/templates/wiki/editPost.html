<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/defaultLayout}">

<div class="container-fluid m-0 p-0" layout:fragment="content">

    <script src="https://cdn.tiny.cloud/1/d34njokcv44llbkidi9xzg4nygezokgli9hsheb7tk7zkqxk/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>


    <dialog id="uploadDialog" class="upload-modal">
        <script>
            function doUploadImage() {
                // disable buttons and show progress
                document.getElementById('uploadProgress').style.display='block';
                document.getElementById('btnUploadSubmit').setAttribute("disabled", "disabled");
                document.getElementById('btnUploadCancel').setAttribute("disabled", "disabled");
                postImageFile();
            }

            async function postImageFile() {
                let formData = new FormData();
                formData.set("fileName", document.getElementById('fileName').value)
                formData.set("fileDescription", document.getElementById('fileDescription').value)
                formData.set("imageFile", document.getElementById('imageFile').files[0])

                const response = await fetch('/api/v1/contentmanager/uploadimage', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    return response.json();
                }).then(data => {
                    navigator.clipboard.writeText(data.fileLocation);
                    completeImageUpload();
                });
            }

            function completeImageUpload() {
                // enable buttons and hide progress
                document.getElementById('uploadProgress').style.display='none';
                document.getElementById('btnUploadSubmit').removeAttribute("disabled");
                document.getElementById('btnUploadCancel').removeAttribute("disabled");
                // close dialog
                document.getElementById("uploadDialog").close();
            }

        </script>
        <h2>Upload Image</h2>
        <div class="flex-column">
            <form id="formUploadImage" method="dialog">
                <div class="row p-2">
                    <div class="col">
                        <label for="fileName" class="form-label">Name:</label>
                    </div>
                    <div class="col">
                        <input class="form-control" id="fileName">
                    </div>
                </div>
                <div class="row p-2">
                    <div class="col">
                        <label for="fileDescription" class="form-label">Description:</label>
                    </div>
                    <div class="col">
                        <input class="form-control" id="fileDescription">
                    </div>
                </div>

                <div class="row p-2">
                    <div class="col">
                        <input class="form-control" id="imageFile" type="file">
                    </div>
                </div>

                <div class="row p-2">
                    <div class="col">
                        <progress id="uploadProgress" style="display: none" />
                    </div>
                </div>

                <div class="row p-2">
                    <div class="col">
                        <button id="btnUploadSubmit" type="button" class="btn btn-sm btn-primary" onclick="doUploadImage()">Submit & Copy</button>
                        <button id="btnUploadCancel" formmethod="dialog" type="submit" class="btn btn-sm btn-outline-primary">Cancel</button>
                    </div>
                </div>

            </form>
        </div>
    </dialog>

    <dialog id="chooseDialog" class="upload-modal">
        <template id="tmpImage">
            <div class="grid_image_div m-1">
                <img src="" alt="" class="grid_image_element">
                <p></p>
            </div>
        </template>
        <script>
            async function loadImages() {
                const chooser = document.getElementById("pictureChooser");
                while (chooser.firstChild) {
                    chooser.removeChild(chooser.lastChild);
                }
                const template = document.getElementById("tmpImage");
                let searchTerm = document.getElementById("imgSearch").value;
                let apiURL = '/api/v1/contentmanager/images';
                if (searchTerm !== "") {
                    apiURL = apiURL + "/" + searchTerm;
                }

                const response = await fetch(apiURL
                ).then(response => {
                    return response.json();
                }).then(data => {
                    console.log(data);
                    for (let key in data) {
                        let obj = data[key];
                        let divID = "id-" + obj.id;

                        let clone = template.content.cloneNode(true);
                        let imgDiv = clone.querySelector("img");
                        imgDiv.src = obj.fileLocation;
                        imgDiv.alt = obj.name;
                        imgDiv.setAttribute("id", divID);
                        imgDiv.addEventListener("click", function (event) {
                            selectImage(event.target, 1);
                        });
                        imgDiv.addEventListener("dblclick", function (event) {
                            selectImage(event.target, 2);
                        });
                        let hdrDiv = clone.querySelector("p");
                        hdrDiv.innerText = obj.name;
                        chooser.appendChild(clone);
                    }
                });
            }

            function selectImage(element, type) {
                const chooser = document.getElementById("pictureChooser");
                let imgArray = chooser.querySelectorAll("img");

                for(let key in imgArray) {
                    let imgNode = imgArray[key];
                    try {imgNode.classList.remove("grid_image_selected_primary")}
                    catch (error) {console.log("not an image")}
                }
                element.classList.add("grid_image_selected_primary");
                let imageFullURL = element.src;
                let imageURL = imageFullURL.substring(websiteDomain.length, imageFullURL.length);
                navigator.clipboard.writeText(imageURL);
                if (type > 1) { dialogOK(); }
            }

            function dialogOK() {
                document.getElementById("chooseDialog").close();
            }
            function imageChooserKeyUp(event) {
                if (event.key == "Enter") { dialogOK() }
            }

        </script>
        <form method="dialog">
            <div class="d-flex">
                <label for="imgSearch" class="form-control-label h4 w-50" style="float: left">Choose Image</label>
                <input id="imgSearch" class="form-control pr-2 w-50" type="text" onkeyup="loadImages()"
                       placeholder="Search" aria-label="Search" style="float:right;">
            </div>

            <div id="pictureChooser" class="border border-1 rounded" onkeyup="imageChooserKeyUp()"
                 style="width: 410px; height: 410px; overflow-x: hidden; overflow-y: scroll"></div>
            <div class="d-flex">
                <button type="button" class="btn btn-sm btn-quaternary m-2 w-25"
                        onclick="dialogOK()">Copy URL</button>
                <button type="button" class="btn btn-sm btn-outline-danger m-2 w-25"
                        onclick="dialogOK()">Cancel</button>
            </div>
        </form>
    </dialog>


    <div th:replace="~{wiki/moduleHeader :: header}">Header</div>

    <div class="mx-2">

        <div class="row mt-2">

            <form id="postEditForm" style="height: 100%" th:action="@{/wiki/admin/post}" th:object="${wikiPost}" method="post">
                <div class="row">
                    <div class="col flex-row">
                        <input type="text" class="form-control-sm flex-grow" style="width: 50%" th:field="*{title}" placeholder="Post Title" />
                        <div style="float: right">
                            <button type="button" class="btn btn-sm btn-primary"
                                    onclick="uploadImageClick()">Upload Image</button>
                            <button type="button" class="btn btn-sm btn-primary"
                                    onclick="chooseImageClick()">Choose Image</button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="processPost()">Save</button>
                        </div>
                    </div>
                </div>
                <dvi class="row">
                    <div class="col">
                        <textarea id="body" name="body" th:field="*{body}" style="width:100%; height: calc(100vh - 200px)"></textarea>
                        <script>
                            tinymce.init({
                                selector: '#body',
                                plugins: 'link lists image media code',
                                toolbar: 'alignleft aligncenter alignright alignjustify | formatselect | bullist numlist | outdent indent | link code',
                                toolbar_mode: 'floating',
                                tinycomments_author: 'Post Author'
                            });
                        </script>
                    </div>
                </dvi>
            </form>

        </div>

    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        websiteDomain = /*[[${baseURL}]]*/ " ";
        /*]]>*/

        function processPost() {

        }
        function uploadImageClick() {
            document.getElementById("uploadDialog").showModal();
        }

        function chooseImageClick() {
            document.getElementById("chooseDialog").showModal();
            loadImages();
        }
    </script>
  </div>

</html>